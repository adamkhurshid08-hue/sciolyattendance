<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>Attendance Tracker (Google Sheets)</title>
  <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    .student-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    .student-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .profile-img { width: 80px; height: 80px; object-fit: cover; border: 3px solid var(--bs-border-color); }
    .status-indicator { position: absolute; top: 10px; right: 10px; width: 12px; height: 12px; border-radius: 50%; }
    .status-in { background-color: var(--bs-success); box-shadow: 0 0 6px var(--bs-success); }
    .status-out { background-color: var(--bs-secondary); }
    .btn-action { min-width: 80px; }
    .last-activity { font-size: 0.85rem; color: var(--bs-secondary-color); }
  </style>
</head>
<body>
<div class="container py-4">
  <h1 class="mb-3"><i class="fas fa-user-check me-2"></i>Attendance Tracker</h1>

  <button id="authorize_button" class="btn btn-primary mb-3">Authorize Google</button>
  <button id="signout_button" class="btn btn-secondary mb-3" style="display:none;">Sign Out</button>

  <div id="students-grid" class="row g-4"></div>
</div>

<script>
/* --- CONFIG --- */
const CLIENT_ID = "1055886700836-sajvukin1408sau8qou1l8eiib7360a4.apps.googleusercontent.com";
const API_KEY = "AIzaSyC8N2Ntstm4g6PxQ8RXUrGE38Ac7ebJMQc";
const SHEET_ID = "1oNVG7sDwFb-SXXDYG0x_M2JJFgg6T2e2sUmZDSF6zM8";
const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

/* --- Demo Data --- */
let students = [
  {id: 1, name: "Alice", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 2, name: "Bob", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 3, name: "Charlie", profile_picture: "https://via.placeholder.com/80", logs: []}
];

let tokenClient;
let gapiInited = false;
let gisInited = false;

function maybeEnableAuth() {
  if (gapiInited && gisInited) {
    document.getElementById("authorize_button").style.display = "inline-block";
  }
}

/* --- Google API Init --- */
function gapiLoaded() {
  gapi.load("client", async () => {
    await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
    gapiInited = true;
    maybeEnableAuth();
  });
}
function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: ""
  });
  gisInited = true;
  maybeEnableAuth();
}

/* --- Auth Buttons --- */
document.getElementById("authorize_button").onclick = () => {
  tokenClient.callback = async (resp) => {
    if (resp.error) throw resp;
    document.getElementById("signout_button").style.display = "inline-block";
    renderStudents();
  };
  if (gapi.client.getToken() === null) {
    tokenClient.requestAccessToken({ prompt: "consent" });
  } else {
    tokenClient.requestAccessToken({ prompt: "" });
  }
};
document.getElementById("signout_button").onclick = () => {
  const token = gapi.client.getToken();
  if (token) {
    google.accounts.oauth2.revoke(token.access_token);
    gapi.client.setToken("");
  }
  document.getElementById("signout_button").style.display = "none";
};

/* --- Sheets Ops --- */
async function appendLog(student, action) {
  const ts = new Date().toISOString();
  await gapi.client.sheets.spreadsheets.values.append({
    spreadsheetId: SHEET_ID,
    range: "A:C",
    valueInputOption: "USER_ENTERED",
    resource: { values: [[student, action, ts]] }
  });
}

/* --- UI --- */
function renderStudents() {
  const grid = document.getElementById("students-grid");
  grid.innerHTML = "";
  students.forEach(s => {
    const lastLog = s.logs[s.logs.length - 1];
    const status = lastLog && lastLog.action === "in" ? "in" : "out";
    const nextAction = status === "in" ? "Exit" : "Enter";
    grid.innerHTML += `
    <div class="col-md-6 col-lg-4">
      <div class="card student-card h-100 position-relative">
        <div class="status-indicator status-${status}" id="status-${s.id}"></div>
        <div class="card-body text-center">
          <img src="${s.profile_picture}" class="rounded-circle profile-img mb-3" alt="${s.name}">
          <h5 class="card-title mb-2">${s.name}</h5>
          <div class="mb-3">
            <span class="badge bg-${status === "in" ? "success" : "secondary"}">
              ${status === "in" ? "Present" : "Absent"}
            </span>
          </div>
          <button class="btn btn-outline-primary btn-action mb-2" onclick="toggleAttendance(${s.id})">
            ${nextAction}
          </button>
          <div class="last-activity">
            ${lastLog ? new Date(lastLog.timestamp).toLocaleString() : "No activity yet"}
          </div>
        </div>
      </div>
    </div>`;
  });
}
async function toggleAttendance(id) {
  const s = students.find(x => x.id === id);
  const lastLog = s.logs[s.logs.length - 1];
  const status = lastLog && lastLog.action === "in" ? "in" : "out";
  const newAction = status === "in" ? "out" : "in";
  const ts = Date.now();
  s.logs.push({action: newAction, timestamp: ts});
  renderStudents();
  await appendLog(s.name, newAction); // write to Google Sheets
}

/* --- Load Google APIs --- */
</script>
<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
<script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
</body>
</html>

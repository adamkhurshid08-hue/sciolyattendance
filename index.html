<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>Attendance Tracker (Service Account)</title>
  <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    .student-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    .student-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .profile-img { width: 80px; height: 80px; object-fit: cover; border: 3px solid var(--bs-border-color); }
    .status-indicator { position: absolute; top: 10px; right: 10px; width: 12px; height: 12px; border-radius: 50%; }
    .status-in { background-color: var(--bs-success); box-shadow: 0 0 6px var(--bs-success); }
    .status-out { background-color: var(--bs-secondary); }
    .btn-action { min-width: 80px; }
    .last-activity { font-size: 0.85rem; color: var(--bs-secondary-color); }
  </style>
</head>
<body>
<div class="container py-4">
  <h1 class="mb-3"><i class="fas fa-user-check me-2"></i>Attendance Tracker</h1>
  <div id="students-grid" class="row g-4"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsrsasign"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
/* --- CONFIG --- */
const SHEET_ID = "1oNVG7sDwFb-SXXDYG0x_M2JJFgg6T2e2sUmZDSF6zM8";
const SERVICE_ACCOUNT = {
  "type": "service_account",
  "project_id": "even-trainer-465822-f8",
  "private_key_id": "9f7259c2907e4a898aa645c5363f801fd0f1baac",
  "private_key": "-----BEGIN PRIVATE KEY-----
    MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCh1XcPc8rO0EeE\njOj5vsnW6GqUVxYWfAbfaVBewYe0cDZotNBAwX/kPvm6syqP7BKs/zqEpizPXmPN\nnfngEYLfnoOT74xAcov8kCXb5mldRroqQj6YCndKO0kzKF78eWJydifzkj9BOs+s\n4WZ2dZJDQ/z17T5WD6yyd2J+CWvaZmLu2BlJLMPNmsVTTNM4ZR7AFt+hP/lCnFyT\nYZ+RDcmv4gXGVaoNhB/80qYeRHiFQ2Roe+c9XYy4KSX0rPGgZS0TTUpG7qDfV3fc\n/5miG9Lep+idoutZDOWMlYy+ZQT1KAJ4ohszwQiI/d8phlhV3GUkVsDuzOmidUqE\n/cw2cp5HAgMBAAECggEAARGfb0Mc8GyHT8Lol9ie8oq7elAtJFPSbbFrG4XybqjB\nmEpjiD/Z3XB41BVeN6X3gFjKI2pamqxvBmryKQOjwGByX7U6XqUfqT+UlKRG1Jvu\nw+LKb3aiO3tHEwOiFjtR843lEJohnkr8uTNe2d9VVkgvMq0+c7t6+wpY61chOH2C\nxf5l+OmsDSeDOkX5RC5JCphAZ4UtTtr+fpMuO031/d9Y0BDN4J2e5Qzkw38ArA5r\nx+bFNmi6Cu0qCFjUHK1Rp7zPww9JZwg9qeb8h40AhnpupAHIqp4WHl/5GeLPykse\nmTS/jgikZOMFQiYC6HlnlWuJ4TFQud/i4GMRBxfkAQKBgQDWhM8iLrrkY2WoipAm\nPrhrDeE5xX9g75lWnCUPURAeujhLF77XteRuqTwTiJdFY6zb5Adh8d1T0RQl/NqN\n7VCrzzq+LRoRaBtLkEDkWPOkWj38HXiGFFslKcldm4LbxUj8sq3SypZwzct3Vsit\nLKZet01rVj+tMjD20Gy7vs6X1wKBgQDBIKBE9U0RqldAlXlWSOGk+ygreNMn3omS\nPHi5fQNgOboyEH8ir3QnR6KyukwaqRje7QgoVS/EsASek4PMhWiqmiWFNEqzEyZ4\nOw2UyACKl1V24wcCSqlY5CzeGVjznXcmFClfqwrGhAKRl0ggGnU+Z7QVSbZvmD9G\nmCYkW3SfEQKBgQCWaLJO9lLmFedOYDEoD6wAq8+yUQ656eUqu/qkHaNe2BTmWfTe\njFNpX9GWpJvj9DpcRysB+rLDtQIajIq1HqMEhB1dAISZldQljDRjpxbVssxpPESo\nRheOHBlrP8Fl1JMTUzjbZl5LI5A40amM+pSALqfizauCBYIdXBARJ3z1KwKBgAOD\n/Ybj1EBTEn2Jewj4EKt5KvUHoQhjw6tW0HfH78zLoDkTFc1i1kF0y2BnhcUieOJt\n/C0Hx/PTpHHii46oiww3/CDdn9J8scGUiZ3AuknLkXG1lkYTZ9vHY42zdmwQ3L9j\ntJEaQvr0IjvWPijfcmztZFjS27BSXCyDzoXw6EGRAoGBAIEsURTsyq+KJ4C3Pt4I\npzYos/2dmLkX7OwmupMFvgeIkNFNHNAU6Ca3owCIBVm6tj6T12g/tO4CJtGaA/ZO\n2UncJS9m4sYhHHnMEgp8R/15QBU1KajzZ/tXxELmfdcHcXjLF0zXIKqDq5xjt0WV\ngcSh3snuB/7MHlTJem0b8uGI
  -----END PRIVATE KEY-----",
  "client_email": "adamkhurshid@even-trainer-465822-f8.iam.gserviceaccount.com",
  "client_id": "113860672492696118370",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/adamkhurshid%40even-trainer-465822-f8.iam.gserviceaccount.com",
  "universe_domain": "googleapis.com"
};

/* --- Demo Data --- */
let students = [
  {id: 1, name: "Sayeed Hossain", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 2, name: "Ana Haridevara", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 3, name: "Andrew Park", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 4, name: "Adam Khurshid", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 5, name: "Adam Mah", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 6, name: "Matteo Scala", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 7, name: "Qiyue (Bella) Yao", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 8, name: "Adil Ahnaf", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 9, name: "Shanum Choudhury", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 10, name: "Navya Shah", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 11, name: "Morgan Agosta", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 12, name: "Ana Huang", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 13, name: "Max Yin", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 14, name: "Ethan Tseng", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 15, name: "Caleb Wu", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 16, name: "Viktor Garrity", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 17, name: "Fatima Shoaib", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 18, name: "Raisha Digorna", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 19, name: "Ryan Caine", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 20, name: "Aleksander Baginski", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 21, name: "Hannah He", profile_picture: "https://via.placeholder.com/80", logs: []},
];

/* --- JWT / Token Generation --- */
async function getAccessToken() {
  const iat = KJUR.jws.IntDate.get('now');
  const exp = iat + 3600;
  const payload = {
    iss: SERVICE_ACCOUNT.client_email,
    scope: "https://www.googleapis.com/auth/spreadsheets",
    aud: SERVICE_ACCOUNT.token_uri,
    exp,
    iat
  };
  const sHeader = { alg: "RS256", typ: "JWT" };
  const jwt = KJUR.jws.JWS.sign("RS256", JSON.stringify(sHeader), JSON.stringify(payload), SERVICE_ACCOUNT.private_key);

  const res = await axios.post(SERVICE_ACCOUNT.token_uri, `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${jwt}`, {
    headers: { "Content-Type": "application/x-www-form-urlencoded" }
  });
  return res.data.access_token;
}

/* --- Sheets Ops --- */
async function appendLog(student, action) {
  const ts = new Date().toISOString();
  const token = await getAccessToken();
  await axios.post(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/A:C:append?valueInputOption=USER_ENTERED`, 
    { values: [[student, action, ts]] },
    { headers: { Authorization: `Bearer ${token}` } }
  );
}

/* --- UI --- */
function renderStudents() {
  const grid = document.getElementById("students-grid");
  grid.innerHTML = "";
  students.forEach(s => {
    const lastLog = s.logs[s.logs.length-1];
    const status = lastLog && lastLog.action==="in" ? "in" : "out";
    const nextAction = status==="in" ? "Exit" : "Enter";
    grid.innerHTML += `
      <div class="col-md-6 col-lg-4">
        <div class="card student-card h-100 position-relative">
          <div class="status-indicator status-${status}" id="status-${s.id}"></div>
          <div class="card-body text-center">
            <img src="${s.profile_picture}" class="rounded-circle profile-img mb-3" alt="${s.name}">
            <h5 class="card-title mb-2">${s.name}</h5>
            <div class="mb-3">
              <span class="badge bg-${status==="in"?"success":"secondary"}">
                ${status==="in"?"Present":"Absent"}
              </span>
            </div>
            <button class="btn btn-outline-primary btn-action mb-2" onclick="toggleAttendance(${s.id})">
              ${nextAction}
            </button>
            <div class="last-activity">
              ${lastLog ? new Date(lastLog.timestamp).toLocaleString() : "No activity yet"}
            </div>
          </div>
        </div>
      </div>`;
  });
}

async function toggleAttendance(id) {
  const s = students.find(x=>x.id===id);
  const lastLog = s.logs[s.logs.length-1];
  const status = lastLog && lastLog.action==="in" ? "in":"out";
  const newAction = status==="in"?"out":"in";
  const ts = Date.now();
  s.logs.push({action:newAction, timestamp:ts});
  renderStudents();
  await appendLog(s.name, newAction);
}

renderStudents();
</script>
</body>
</html>

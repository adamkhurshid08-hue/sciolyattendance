<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>Attendance Tracker (Google Sheets)</title>
  <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    .student-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    .student-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .profile-img { width: 80px; height: 80px; object-fit: cover; border: 3px solid var(--bs-border-color); }
    .status-indicator { position: absolute; top: 10px; right: 10px; width: 12px; height: 12px; border-radius: 50%; }
    .status-in { background-color: var(--bs-success); box-shadow: 0 0 6px var(--bs-success); }
    .status-out { background-color: var(--bs-secondary); }
    .btn-action { min-width: 80px; }
    .last-activity { font-size: 0.85rem; color: var(--bs-secondary-color); }
  </style>
</head>
<body>
<div class="container py-4">
  <h1 class="mb-3"><i class="fas fa-user-check me-2"></i>Attendance Tracker</h1>

  <button id="authorize_button" class="btn btn-primary mb-3">Authorize (Only Once)</button>
  <div id="students-grid" class="row g-4"></div>
</div>

<script>
/* --- CONFIG --- */
const CLIENT_ID = "113860672492696118370";
const API_KEY = "9f7259c2907e4a898aa645c5363f801fd0f1baac";
const SHEET_ID = "1oNVG7sDwFb-SXXDYG0x_M2JJFgg6T2e2sUmZDSF6zM8";
const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

/* --- Demo Data --- */
let students = [
  {id: 1, name: "Alice", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 2, name: "Bob", profile_picture: "https://via.placeholder.com/80", logs: []},
  {id: 3, name: "Charlie", profile_picture: "https://via.placeholder.com/80", logs: []}
];

let tokenClient;
let gapiInited = false;
let gisInited = false;

function maybeEnableAuth() {
  if (gapiInited && gisInited) {
    document.getElementById("authorize_button").style.display = "inline-block";
  }
}

/* --- Google API Init --- */
function gapiLoaded() {
  gapi.load("client", async () => {
    await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
    gapiInited = true;
    maybeEnableAuth();
  });
}
function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: handleTokenResponse
  });
  gisInited = true;
  maybeEnableAuth();
}

function handleTokenResponse(resp) {
  if (resp.error) throw resp;
  localStorage.setItem("gs_token", JSON.stringify(resp));
  renderStudents();
}

async function authorizeOnce() {
  const saved = localStorage.getItem("gs_token");
  if (saved) {
    const tokenObj = JSON.parse(saved);
    gapi.client.setToken(tokenObj);
    renderStudents();
  } else {
    tokenClient.requestAccessToken({ prompt: "consent" });
  }
}

document.getElementById("authorize_button").onclick = authorizeOnce;

/* --- Sheets Ops --- */
async function appendLog(student, action) {
  const ts = new Date().toISOString();
  await gapi.client.sheets.spreadsheets.values.append({
    spreadsheetId: SHEET_ID,
    range: "A:C",
    valueInputOption: "USER_ENTERED",
    resource: { values: [[student, action, ts]] }
  });
}

/* --- Summary Sheet --- */
async function ensureSummarySheet() {
  const spreadsheet = await gapi.client.sheets.spreadsheets.get({ spreadsheetId: SHEET_ID });
  let sheetExists = spreadsheet.result.sheets.some(s => s.properties.title === "Summary");
  if (!sheetExists) {
    await gapi.client.sheets.spreadsheets.batchUpdate({
      spreadsheetId: SHEET_ID,
      resource: { requests: [{ addSheet: { properties: { title: "Summary" } } }] }
    });
  }
}

async function generateSummarySheet() {
  await ensureSummarySheet();
  const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: "A:C" });
  const rows = res.result.values || [];
  let perStudent = {};
  rows.forEach(([student, action, ts]) => {
    const d = new Date(ts);
    const day = `${d.getMonth()+1}/${d.getDate()}/25`;
    perStudent[student] = perStudent[student] || {};
    perStudent[student][day] = perStudent[student][day] || 0;
    if (!perStudent[student].lastIn && action === "in") perStudent[student].lastIn = d;
    else if (perStudent[student].lastIn && action === "out") {
      const hours = (d - perStudent[student].lastIn)/(1000*60*60);
      perStudent[student][day] += hours;
      perStudent[student].lastIn = null;
    }
  });
  const allDays = [...new Set(rows.map(r=>new Date(r[2])).map(d=>`${d.getMonth()+1}/${d.getDate()}/25`))].sort();
  const header = ["student", ...allDays, "totalHours", "meanHours","medianHours","meanNoZeroHours","medianNoZeroHours"];
  const data = [header];
  for (let student in perStudent) {
    const dayVals = allDays.map(d => perStudent[student][d] || 0);
    const total = dayVals.reduce((a,b)=>a+b,0);
    const mean = dayVals.length ? total/dayVals.length : 0;
    const sorted = [...dayVals].sort((a,b)=>a-b);
    const median = sorted.length ? sorted[Math.floor(sorted.length/2)] : 0;
    const nonZero = dayVals.filter(v=>v>0);
    const meanNZ = nonZero.length ? nonZero.reduce((a,b)=>a+b,0)/nonZero.length : 0;
    const medianNZ = nonZero.length ? nonZero.sort((a,b)=>a-b)[Math.floor(nonZero.length/2)] : 0;
    data.push([student, ...dayVals.map(v=>v.toFixed(2)), total.toFixed(2), mean.toFixed(2), median.toFixed(2), meanNZ.toFixed(2), medianNZ.toFixed(2)]);
  }
  await gapi.client.sheets.spreadsheets.values.clear({ spreadsheetId: SHEET_ID, range: "Summary!A:Z" });
  await gapi.client.sheets.spreadsheets.values.update({
    spreadsheetId: SHEET_ID,
    range: "Summary!A1",
    valueInputOption: "USER_ENTERED",
    resource: { values: data }
  });
  alert("Summary sheet updated!");
}

/* --- UI --- */
function renderStudents() {
  const grid = document.getElementById("students-grid");
  grid.innerHTML = "";
  students.forEach(s => {
    const lastLog = s.logs[s.logs.length - 1];
    const status = lastLog && lastLog.action === "in" ? "in" : "out";
    const nextAction = status === "in" ? "Exit" : "Enter";
    grid.innerHTML += `
    <div class="col-md-6 col-lg-4">
      <div class="card student-card h-100 position-relative">
        <div class="status-indicator status-${status}" id="status-${s.id}"></div>
        <div class="card-body text-center">
          <img src="${s.profile_picture}" class="rounded-circle profile-img mb-3" alt="${s.name}">
          <h5 class="card-title mb-2">${s.name}</h5>
          <div class="mb-3">
            <span class="badge bg-${status === "in" ? "success" : "secondary"}">
              ${status === "in" ? "Present" : "Absent"}
            </span>
          </div>
          <button class="btn btn-outline-primary btn-action mb-2" onclick="toggleAttendance(${s.id})">
            ${nextAction}
          </button>
          <div class="last-activity">
            ${lastLog ? new Date(lastLog.timestamp).toLocaleString() : "No activity yet"}
          </div>
        </div>
      </div>
    </div>`;
  });
}

async function toggleAttendance(id) {
  const s = students.find(x => x.id === id);
  const lastLog = s.logs[s.logs.length - 1];
  const status = lastLog && lastLog.action === "in" ? "in" : "out";
  const newAction = status === "in" ? "out" : "in";
  const ts = Date.now();
  s.logs.push({action: newAction, timestamp: ts});
  renderStudents();
  await appendLog(s.name, newAction); // write to Google Sheets
}

/* --- Load Google APIs --- */
</script>
<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
<script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
</body>
</html>
